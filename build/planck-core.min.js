!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global.Planck=global.Planck||{})}(this,function(exports){"use strict";function Namespace(){var name=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,symbol=Symbol(name);return function namespace(object){var init=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(data){return data};return void 0===object[symbol]&&(object[symbol]=init({})),object[symbol]}}function AssertionError(message){this.message=message}function resolveRelativePath(parts){return parts.reduce(function(result,part){return 0===part.length||"."===part?result:".."===part?(result.pop(),result):[].concat(toConsumableArray(result),[part])},[])}function ImplementationError(message){this.message=message}function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),toConsumableArray=function(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)},internal$1=Namespace("AggregateFunction"),AggregateFunction=function(){function AggregateFunction(){var targets=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];classCallCheck(this,AggregateFunction),internal$1(this).targets=targets}return createClass(AggregateFunction,[{key:"apply",value:function apply(target,bound,args){return internal$1(this).targets.map(function(target){return Reflect.apply(target,bound,args)})}},{key:"getPrototypeOf",value:function getPrototypeOf(target){return this.constructor.prototype}}],[{key:"new",value:function _new(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var instance=new(Function.prototype.bind.apply(this,[null].concat(args)));return new Proxy(function(){},instance)}}]),AggregateFunction}(),internal$$1=Namespace("Aggregate"),Aggregate=function(){function Aggregate(){var targets=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];classCallCheck(this,Aggregate),internal$$1(this).targets=targets}return createClass(Aggregate,[{key:"set",value:function set$$1(target,property,value,receiver){return internal$$1(this).targets.forEach(function(target){Reflect.set(target,property,value)}),Reflect.set(target,property,value,receiver)}},{key:"get",value:function get$$1(target,property,receiver){var scope=internal$$1(this);return scope.targets.every(function(target){return"function"==typeof Reflect.get(target,property)})?AggregateFunction.new(scope.targets.map(function(target){return Reflect.get(target,property).bind(target)})):Reflect.get(scope.targets[0],property,receiver)}},{key:"getPrototypeOf",value:function getPrototypeOf(target){return this.constructor.prototype}}],[{key:"new",value:function _new(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];var instance=new(Function.prototype.bind.apply(this,[null].concat(args)));return new Proxy({},instance)}}]),Aggregate}();Object.setPrototypeOf(AssertionError,Error),AssertionError.prototype=Object.create(Error.prototype),AssertionError.prototype.name="AssertionError",AssertionError.prototype.message="",AssertionError.prototype.constructor=AssertionError;var Environment=function(){function Environment(){classCallCheck(this,Environment)}return createClass(Environment,null,[{key:"type",get:function get$$1(){try{if(new Function("return this === window")())return"browser"}catch(error){}try{if(new Function("return this === self")())return"worker"}catch(error){}try{if(new Function("return this === global")())return"node"}catch(error){}throw new Error}},{key:"global",get:function get$$1(){switch(this.type){case"browser":return window;case"worker":return self;case"node":return global}throw new Error}}]),Environment}(),path=void 0;"node"===Environment.type&&(path=require("path"));var FilePath=function(){function FilePath(){classCallCheck(this,FilePath)}return createClass(FilePath,null,[{key:"resolve",value:function resolve(arg){var separator=void 0,root=void 0;"node"!==Environment.type?(separator="/",root=this.self.split("/").slice(0,-2).join("/")+"/"):(separator=path.sep,root="");var first=arg;first.startsWith(root)&&(first=first.substr(root.length));for(var _len=arguments.length,rest=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)rest[_key-1]=arguments[_key];return root+[].concat(toConsumableArray(resolveRelativePath(first.split(separator))),toConsumableArray(resolveRelativePath(rest.reduce(function(parts,part){return[].concat(toConsumableArray(parts),toConsumableArray(part.split(separator)))},[])))).join(separator)}},{key:"self",get:function get$$1(){switch(Environment.type){case"browser":return document.currentScript.src;case"worker":return self.location.href;case"node":return __filename}throw new Error}}]),FilePath}();Object.setPrototypeOf(ImplementationError,Error),ImplementationError.prototype=Object.create(Error.prototype),ImplementationError.prototype.name="ImplementationError",ImplementationError.prototype.message="",ImplementationError.prototype.constructor=ImplementationError;var internal$4=Namespace("Multiton"),Multiton=function(){function Multiton(key){if(classCallCheck(this,Multiton),this.constructor.has(key))throw new Error('Attempt to create multiple instances for key "'+key+'"')}return createClass(Multiton,null,[{key:"has",value:function has(key){var scope=internal$4(this);if(void 0===scope.instances)return!1;var coercedKey=this.coerceMultitonKey(key);return void 0!==scope.instances[coercedKey]}},{key:"for",value:function _for(key){var scope=internal$4(this);scope.instances||(scope.instances=new Map);var coercedKey=this.coerceMultitonKey(key);if(scope.instances.has(coercedKey))return scope.instances.get(coercedKey);for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key];var instance=this.new.apply(this,[coercedKey].concat(args));return scope.instances.set(coercedKey,instance),instance}},{key:"new",value:function _new(){for(var _len2=arguments.length,args=Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];return new(Function.prototype.bind.apply(this,[null].concat(args)))}},{key:"coerceMultitonKey",value:function coerceMultitonKey(key){return key}}]),Multiton}(),internal$5=Namespace("Semaphore"),Task=function Task(semaphore,callback){var _this=this;classCallCheck(this,Task);var promises=[new Promise(function(resolve,reject){_this.resolve=resolve,_this.reject=reject}),new Promise(function(resolve){_this.let=resolve}).then(function(){callback(_this.resolve,_this.reject)})];this.promise=Promise.all(promises).then(function(values){return semaphore.signal(),values[0]},function(reason){return semaphore.signal(),Promise.reject(reason)})},Semaphore=function(){function Semaphore(capacity){classCallCheck(this,Semaphore);var scope=internal$5(this);scope.capacity=capacity,scope.available=capacity,scope.queue=[]}return createClass(Semaphore,[{key:"wait",value:function wait(callback){var scope=internal$5(this),task=new Task(this,callback);return 0===scope.available?scope.queue.push(task):(--scope.available,task.let()),task.promise}},{key:"signal",value:function signal(){var scope=internal$5(this);0===scope.queue.length?++scope.available:scope.queue.shift().let()}},{key:"capacity",get:function get$$1(){return internal$5(this).capacity}},{key:"available",get:function get$$1(){return internal$5(this).available}}]),Semaphore}(),internal$6=Namespace("Singleton"),Singleton=function(){function Singleton(){if(classCallCheck(this,Singleton),void 0!==internal$6(this.constructor).instance)throw new Error("Attempt to create multiple instances for singleton")}return createClass(Singleton,null,[{key:"get",value:function get$$1(){var scope=internal$6(this);return void 0===scope.instance&&(scope.instance=this.new.apply(this,arguments)),scope.instance}},{key:"new",value:function _new(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return new(Function.prototype.bind.apply(this,[null].concat(args)))}}]),Singleton}(),Stride=function(){function Stride(){classCallCheck(this,Stride)}return createClass(Stride,null,[{key:"transform",value:function transform(array,stride,callback){var values=[];return array.forEach(function(value,index){var modulo=index%stride;if(values[modulo]=value,modulo===stride-1)for(var transformed=callback.apply(void 0,values.concat([Math.floor(index/stride)])),offset=0;offset<stride;++offset)array[index-(stride-offset-1)]=transformed[offset]}),array}},{key:"forEach",value:function forEach(array,stride,callback){var values=[];array.forEach(function(value,index){var modulo=index%stride;values[modulo]=value,modulo===stride-1&&callback.apply(void 0,values.concat([Math.floor(index/stride)]))})}},{key:"some",value:function some(array,stride,callback){var values=[];return array.some(function(value,index){var modulo=index%stride;return values[modulo]=value,modulo===stride-1&&callback.apply(void 0,values.concat([Math.floor(index/stride)]))})}},{key:"every",value:function every(array,stride,callback){var values=[];return array.every(function(value,index){var modulo=index%stride;return values[modulo]=value,modulo!==stride-1||callback.apply(void 0,values.concat([Math.floor(index/stride)]))})}},{key:"reduce",value:function reduce(array,stride,callback,initial){var values=[];return array.reduce(function(result,value,index){var modulo=index%stride;return values[modulo]=value,modulo===stride-1?callback.apply(void 0,[result].concat(values,[Math.floor(index/stride)])):result},initial)}}]),Stride}(),base64Arraybuffer=createCommonjsModule(function(module,exports){!function(){for(var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",lookup=new Uint8Array(256),i=0;i<chars.length;i++)lookup[chars.charCodeAt(i)]=i;exports.encode=function(arraybuffer){var bytes=new Uint8Array(arraybuffer),i,len=bytes.length,base64="";for(i=0;i<len;i+=3)base64+=chars[bytes[i]>>2],base64+=chars[(3&bytes[i])<<4|bytes[i+1]>>4],base64+=chars[(15&bytes[i+1])<<2|bytes[i+2]>>6],base64+=chars[63&bytes[i+2]];return len%3==2?base64=base64.substring(0,base64.length-1)+"=":len%3==1&&(base64=base64.substring(0,base64.length-2)+"=="),base64},exports.decode=function(base64){var bufferLength=.75*base64.length,len=base64.length,i,p=0,encoded1,encoded2,encoded3,encoded4;"="===base64[base64.length-1]&&(bufferLength--,"="===base64[base64.length-2]&&bufferLength--);var arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i=0;i<len;i+=4)encoded1=lookup[base64.charCodeAt(i)],encoded2=lookup[base64.charCodeAt(i+1)],encoded3=lookup[base64.charCodeAt(i+2)],encoded4=lookup[base64.charCodeAt(i+3)],bytes[p++]=encoded1<<2|encoded2>>4,bytes[p++]=(15&encoded2)<<4|encoded3>>2,bytes[p++]=(3&encoded3)<<6|63&encoded4;return arraybuffer}}()});if("node"===Environment.type){var encoding=require("text-encoding");void 0===Environment.global.TextEncoder&&(Environment.global.TextEncoder=encoding.TextEncoder),void 0===Environment.global.TextDecoder&&(Environment.global.TextDecoder=encoding.TextDecoder)}var Transferral=function(){function Transferral(){classCallCheck(this,Transferral)}return createClass(Transferral,null,[{key:"encode",value:function encode$$1(object){if("function"!=typeof TextEncoder)throw new Error("TextEncoder is missing");var encoder=new TextEncoder,text=JSON.stringify(object);return encoder.encode(text).buffer}},{key:"decode",value:function decode$$1(buffer){if("function"!=typeof TextDecoder)throw new Error("TextDecoder is missing");var decoder=new TextDecoder,view=new DataView(buffer),text=decoder.decode(view);return JSON.parse(text)}},{key:"pack",value:function pack(buffer){return base64Arraybuffer.encode(buffer)}},{key:"unpack",value:function unpack(string){return base64Arraybuffer.decode(string)}},{key:"packBufferGeometry",value:function packBufferGeometry(geometry){var _this=this;Object.values(geometry.data.attributes).forEach(function(attribute){var constructor=Environment.global[attribute.type],buffer=new constructor(attribute.array).buffer;attribute.array=_this.pack(buffer)})}},{key:"unpackBufferGeometry",value:function unpackBufferGeometry(geometry){var _this2=this;Object.values(geometry.data.attributes).forEach(function(attribute){var constructor=Environment.global[attribute.type],buffer=_this2.unpack(attribute.array);attribute.array=Array.from(new constructor(buffer))})}}]),Transferral}();exports.Aggregate=Aggregate,exports.AggregateFunction=AggregateFunction,exports.AssertionError=AssertionError,exports.Environment=Environment,exports.FilePath=FilePath,exports.ImplementationError=ImplementationError,exports.Multiton=Multiton,exports.Namespace=Namespace,exports.Semaphore=Semaphore,exports.Singleton=Singleton,exports.Stride=Stride,exports.Transferral=Transferral,Object.defineProperty(exports,"__esModule",{value:!0})});